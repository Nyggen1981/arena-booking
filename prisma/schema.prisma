// Prisma schema for idrettslag booking system
// Designed to be multi-tenant (can be sold to multiple clubs)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Organization/Club - for multi-tenant support
model Organization {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  logo           String?
  tagline        String   @default("Kalender")
  primaryColor   String   @default("#2563eb")
  secondaryColor String   @default("#1e40af")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Subscription / license control
  isActive           Boolean   @default(true)  // Set to false to disable all access for this club
  subscriptionEndsAt DateTime?             // Optional: contract end date
  graceEndsAt        DateTime?             // Optional: last day with read-only access

  // License server integration
  licenseServerUrl   String?   // URL to the central license server
  licenseKey         String?   // License key provided by the license server
  licenseOrgSlug     String?   // Organization slug on the license server

  // SMTP settings per organization (optional - falls back to global env vars if not set)
  smtpHost       String?  // e.g., smtp.office365.com, smtp.gmail.com
  smtpPort       Int?     // e.g., 587, 465
  smtpUser       String?  // Email address or username
  smtpPass       String?  // Password or app password (encrypted in production)
  smtpFrom       String?  // From email address (defaults to smtpUser if not set)

  users     User[]
  resources Resource[]
  bookings  Booking[]
  emailTemplates EmailTemplate[]
}

// User with role-based access
model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  password   String
  role       String   @default("user") // "admin", "moderator", "user"
  phone      String?
  isApproved Boolean  @default(false)  // Must be approved by admin to use system
  approvedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  bookings          Booking[]
  approvedBookings  Booking[] @relation("ApprovedBy")
  preferences       UserPreferences?
  moderatedResources ResourceModerator[]

  @@index([organizationId, isApproved])
}

// User preferences for calendar/view settings
model UserPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Calendar view preferences
  defaultCalendarView String   @default("week") // "week" or "month"
  defaultResourceId   String?  // Default resource to show
  selectedResourceIds String?  // JSON array of selected resource IDs
  selectedCategoryIds String?  // JSON array of selected category IDs
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Resource category (Stadium, Hall, etc.)
model ResourceCategory {
  id          String  @id @default(cuid())
  name        String
  description String?
  icon        String?
  color       String  @default("#3b82f6")

  resources Resource[]
}

// Main resource (e.g., "Hovedstadion", "Idrettshall")
model Resource {
  id          String  @id @default(cuid())
  name        String
  description String?
  location    String?
  image       String?
  mapImage    String?  // Overview map/floorplan image
  color       String?  // Custom color for this facility
  isActive    Boolean @default(true)
  showOnPublicCalendar Boolean @default(true)  // Show on public calendar
  // Optional price information (legacy - kept for backwards compatibility)
  prisInfo    String?    // Text shown under "Prisinfo"
  visPrisInfo Boolean?   // Whether price info should be shown
  
  // Part booking settings
  blockPartsWhenWholeBooked Boolean @default(true)  // When whole facility is booked, block all parts
  blockWholeWhenPartBooked  Boolean @default(true)  // When a part is booked, block "whole facility" option
  allowWholeBooking         Boolean @default(true)  // Allow booking entire facility (false = must select a part)

  // Booking settings
  minBookingMinutes  Int?    // null = no limit
  maxBookingMinutes  Int?    // null = no limit
  requiresApproval   Boolean @default(true)
  advanceBookingDays Int?    @default(30)

  // Opening hours (stored as JSON string)
  openingHours String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  categoryId String?
  category   ResourceCategory? @relation(fields: [categoryId], references: [id])

  parts    ResourcePart[]
  bookings Booking[]
  moderators ResourceModerator[]

  // Indexes for faster queries
  @@index([organizationId, isActive])
  @@index([categoryId])
  @@index([showOnPublicCalendar])
}

// Part of a resource (e.g., "Bane 1", "Bane 2", "Halv hall")
// Supports hierarchy: parent parts block all children when booked
model ResourcePart {
  id          String  @id @default(cuid())
  name        String
  description String?
  capacity    Int?
  isActive    Boolean @default(true)
  adminNote   String?
  
  // Map marker coordinates (JSON: {points: [{x,y}]} for polygon)
  mapCoordinates String?

  // Hierarchy - parent part (null = top level)
  parentId    String?
  parent      ResourcePart?  @relation("PartHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ResourcePart[] @relation("PartHierarchy")

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  bookings Booking[]
  
  @@index([parentId])
  @@index([resourceId])
}

// Booking request
model Booking {
  id          String  @id @default(cuid())
  title       String
  description String?

  startTime DateTime
  endTime   DateTime

  // Status: pending, approved, rejected, cancelled
  status String @default("pending")

  // Optional: rejection/cancellation reason
  statusNote String?

  // Contact info for the booking
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Recurring booking support
  isRecurring      Boolean   @default(false)
  recurringPattern String? // weekly, biweekly, monthly
  recurringEndDate DateTime?
  parentBookingId  String?

  // When the user has seen a status change (approved/rejected) in the UI
  userSeenAt DateTime?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  resourcePartId String?
  resourcePart   ResourcePart? @relation(fields: [resourcePartId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  approvedById String?
  approvedBy   User?   @relation("ApprovedBy", fields: [approvedById], references: [id])

  // Indexes for faster queries
  @@index([resourceId, status, startTime])
  @@index([userId])
  @@index([organizationId])
  @@index([startTime])
  @@index([status])
  @@index([parentBookingId]) // For recurring bookings
  
  // Composite indexes for conflict checking (double booking detection)
  @@index([resourceId, status, startTime, endTime]) // For whole facility bookings
  @@index([resourceId, resourcePartId, status, startTime, endTime]) // For part bookings
  @@index([resourceId, status, resourcePartId]) // For filtering by part
}

// Resource Moderator - Links moderators to specific resources they can manage
model ResourceModerator {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
}

// Email templates for customizing automated emails
model EmailTemplate {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  templateType   String   // "new_booking", "approved", "rejected", "cancelled_by_admin", "cancelled_by_user"
  subject        String   // Email subject (supports variables like {{bookingTitle}})
  htmlBody       String   // HTML email body (supports variables)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, templateType])
  @@index([organizationId])
}
